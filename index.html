<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Loksewa Exam Master Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Serif+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --success: #00e676;
            --danger: #ff1744;
            --text-main: #ffffff;
            --ui-font: 'Poppins', sans-serif;
            --exam-font: 'Noto Serif Devanagari', serif;
        }

        /* --- HYPER-VIBRANT ANIMATED BACKGROUND --- */
        body {
            font-family: var(--ui-font);
            margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(-45deg, #ff00cc, #333399, #00d2ff, #3a7bd5);
            background-size: 400% 400%;
            animation: vibrantBG 12s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
        }
        @keyframes vibrantBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- SCREENS --- */
        .screen { display: none; min-height: 100vh; padding-bottom: 50px; }
        .screen.active { display: block; animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9) translateY(30px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- HEADER --- */
        header { padding: 30px 20px 10px; text-align: center; }
        header h1 {
            margin: 0; font-size: 2.8rem; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            background: linear-gradient(to right, #fff, #f0f0f0);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255,255,255,0.4);
        }
        header p { margin: 5px 0 20px; font-weight: 600; color: #e0e7ff; letter-spacing: 1px; }

        .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }

        /* --- DARK GLASS CARDS WITH NEON GLOW --- */
        .card {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px; padding: 35px 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.05);
            margin-bottom: 20px; position: relative; overflow: hidden;
        }

        /* --- INPUTS --- */
        input, select {
            width: 100%; padding: 18px; margin: 10px 0 25px 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.5); color: #fff;
            border-radius: 16px; font-size: 1.1rem; font-family: var(--ui-font);
            box-sizing: border-box; transition: 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #00d2ff; outline: none;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
        }
        select option { background: #0f172a; color: #fff; }

        /* Secure Password Box Styling */
        .input-secure {
            text-align: center; font-weight: 900; font-size: 1.2rem; letter-spacing: 8px;
            color: var(--success); border-color: rgba(0, 230, 118, 0.3); background: rgba(0,0,0,0.8);
            cursor: not-allowed;
        }
        .input-secure:focus { border-color: rgba(0, 230, 118, 0.3); box-shadow: none; }

        /* --- GLOWING ANIMATED BUTTONS --- */
        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 16px;
            font-size: 1.2rem; font-weight: 800; cursor: pointer;
            transition: all 0.2s; display: block; box-sizing: border-box;
            position: relative; color: white; text-transform: uppercase; letter-spacing: 1px;
            z-index: 1;
        }
        .btn:active { transform: scale(0.95); }

        /* Magic Glowing Border Button */
        .btn-magic { background: #0f172a; overflow: visible; }
        .btn-magic::before {
            content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px;
            background: linear-gradient(90deg, #ff00cc, #333399, #00d2ff, #ff00cc);
            background-size: 300%; z-index: -1; border-radius: 19px;
            animation: gradientBorder 3s linear infinite;
        }
        .btn-magic::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.9); border-radius: 16px; z-index: -1;
        }
        .btn-magic:hover::before { filter: blur(10px); }

        .btn-success { background: linear-gradient(135deg, #00b09b, #96c93d); box-shadow: 0 0 20px rgba(150, 201, 61, 0.5); }
        .btn-premium { background: linear-gradient(135deg, #f12711, #f5af19); box-shadow: 0 0 20px rgba(245, 175, 25, 0.5); animation: pulseGlow 2s infinite; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); margin-top: 15px; }

        @keyframes gradientBorder { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 15px rgba(245, 175, 25, 0.4); } 50% { box-shadow: 0 0 30px rgba(245, 175, 25, 0.8); } 100% { box-shadow: 0 0 15px rgba(245, 175, 25, 0.4); } }

        /* --- COLORFUL TOPIC GRID --- */
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .topic-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 16px; 
            font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; cursor: pointer;
            transition: all 0.3s ease; position: relative; overflow: hidden;
            opacity: 0; animation: slideIn 0.5s forwards;
        }
        .topic-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg); transition: 0.5s;
        }
        .topic-btn:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: #00d2ff; background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 10px 30px rgba(0, 210, 255, 0.3);
        }
        .topic-btn:hover::before { left: 150%; }
        
        .topic-badge {
            background: linear-gradient(135deg, #ff00cc, #333399);
            color: white; font-size: 0.9rem; font-weight: 900;
            padding: 8px 14px; border-radius: 12px; margin-right: 15px; flex-shrink: 0;
            box-shadow: 0 0 15px rgba(255, 0, 204, 0.5);
        }

        /* --- EXAM PAPER MODE (HIGH READABILITY) --- */
        .exam-paper {
            background: #ffffff; color: #111;
            padding: 40px 30px; border-radius: 20px;
            box-shadow: 0 0 40px rgba(0,0,0,0.3);
            font-family: var(--exam-font); position: relative;
        }
        .question-text { font-size: 1.6rem; font-weight: 700; margin-bottom: 30px; line-height: 1.6; }
        
        .option-row {
            padding: 16px 20px; border: 2px solid #e2e8f0; margin-bottom: 12px;
            border-radius: 14px; cursor: pointer; font-size: 1.25rem; font-weight: 600;
            display: flex; align-items: center; transition: 0.2s; background: #f8fafc;
        }
        .option-row:hover { border-color: #6366f1; transform: scale(1.02); }
        .opt-letter { font-weight: 900; margin-right: 15px; color: #fff; background: #6366f1; padding: 6px 14px; border-radius: 8px; font-family: var(--ui-font); }
        
        .option-row.correct { background: #00e676; border-color: #00c853; color: #000; box-shadow: 0 0 20px rgba(0, 230, 118, 0.4); }
        .option-row.correct .opt-letter { background: #000; color: #00e676; }
        
        .option-row.wrong { background: #ff1744; border-color: #d50000; color: #fff; box-shadow: 0 0 20px rgba(255, 23, 68, 0.4); }
        .option-row.wrong .opt-letter { background: #000; color: #ff1744; }

        .explanation {
            margin-top: 25px; padding: 20px; background: #e0e7ff;
            border-left: 6px solid #6366f1; font-size: 1.2rem; display: none;
            border-radius: 0 12px 12px 0; animation: popIn 0.4s ease;
        }

        /* --- NEON PROGRESS BAR --- */
        .progress-container { width: 100%; background: rgba(0,0,0,0.5); border-radius: 20px; height: 14px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00d2ff, #3a7bd5); width: 0%; transition: width 0.4s; border-radius: 20px; box-shadow: 0 0 15px #00d2ff;}
        .score-badge { background: rgba(0,0,0,0.6); border: 1px solid #00d2ff; padding: 8px 20px; border-radius: 20px; font-weight: 800; color: #00d2ff; text-shadow: 0 0 10px rgba(0,210,255,0.5); }

        /* --- RESULT SCREEN CIRCLE --- */
        .result-circle {
            width: 180px; height: 180px; border-radius: 50%;
            background: conic-gradient(#00e676 0%, #333 0%);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 30px auto; position: relative;
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.3);
        }
        .result-circle::before {
            content: ""; position: absolute; inset: 15px; border-radius: 50%;
            background: #0f172a; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .result-score-text { position: relative; font-size: 3rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.5); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #00d2ff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <header>
            <h1>Loksewa Pro</h1>
            <p>Interactive Exam Preparation</p>
        </header>
        <div class="container">
            <div class="card">
                <h2 style="text-align: center; margin-top: 0; font-weight: 900; font-size: 2rem;">Welcome</h2>
                <p style="text-align: center; color: #cbd5e1; margin-bottom: 30px;">Enter your details to generate your exam dashboard.</p>
                
                <input type="text" id="input-name" placeholder="Enter Full Name">
                <select id="input-qual">
                    <option value="" disabled selected>Select Qualification</option>
                    <option value="Sub Engineer">Sub Engineer</option>
                    <option value="Engineer">Engineer</option>
                    <option value="Asst Sub Engineer">Asst. Sub Engineer</option>
                </select>
                <button class="btn btn-magic" onclick="app.registerUser()">Enter Portal ‚ûî</button>
            </div>
        </div>
    </div>

    <div id="screen-dash" class="screen">
        <header>
            <h1 id="dash-greeting">Dashboard</h1>
            <p>Select a syllabus topic to begin.</p>
        </header>
        <div class="container">
            <div id="topics-container" class="topic-grid"></div>
        </div>
    </div>

    <div id="screen-topic-detail" class="screen">
        <header>
            <h1 id="detail-topic-title" style="font-size: 1.8rem;">Topic Title</h1>
        </header>
        <div class="container">
            <div class="card" style="text-align: center;">
                <h3 style="margin-top:0; font-size: 1.6rem;">Select Practice Set</h3>
                <p style="color:#cbd5e1; margin-bottom: 30px;">Engage in a realistic, time-efficient mock exam.</p>

                <button class="btn btn-magic" style="margin-bottom: 20px;" onclick="app.loadSet('A')">
                    Set A - Free Preview (First 20)
                </button>
                
                <button id="btn-set-b" class="btn btn-premium" onclick="app.loadSet('B')">
                    Set B - Premium MCQs üîê
                </button>

                <button class="btn btn-outline" onclick="app.showScreen('screen-dash')">‚Üê Back to Topics</button>
            </div>
        </div>
    </div>

    <div id="screen-premium" class="screen">
        <header>
            <h1>Unlock Premium üîê</h1>
        </header>
        <div class="container">
            <div class="card" style="text-align: center;">
                <h2 style="font-weight: 900; font-size: 2rem;">Full Access</h2>
                <p style="color:#cbd5e1; margin-bottom: 20px;">Unlock Set B across the entire syllabus permanently.</p>
                
                <input type="text" id="input-code" placeholder="ENTER SECRET CODE" style="text-align:center; font-weight:900; font-size: 1.4rem; letter-spacing: 4px; text-transform: uppercase;">
                
                <input type="text" id="input-password" class="input-secure" placeholder="PASSWORD AUTO-FILL" readonly>
                
                <button id="btn-verify" class="btn btn-success" style="margin-bottom: 25px;" onclick="app.verifyCode()">
                    Verify & Unlock
                </button>
                
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 30px 0;">
                
                <button class="btn btn-premium" style="margin-bottom: 15px;" onclick="app.requestWhatsAppCode()">
                    Get Code via WhatsApp üí¨
                </button>

                <button class="btn btn-outline" onclick="app.showScreen('screen-topic-detail')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="container" style="padding-top: 30px;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span id="quiz-progress-text" style="font-weight: 900; font-size: 1.2rem;">Q: 1/20</span>
                <span id="quiz-score" class="score-badge">Score: 0</span>
            </div>
            
            <div class="progress-container">
                <div id="progress-fill" class="progress-fill"></div>
            </div>

            <div class="exam-paper">
                <div id="question-text" class="question-text">Loading question...</div>
                <div id="options-container"></div>
                <div id="explanation-box" class="explanation"></div>
            </div>

            <button id="btn-next" class="btn btn-magic hidden" style="margin-top: 30px;" onclick="app.nextQuestion()">Next Question ‚ûî</button>
            <button class="btn btn-outline" style="margin-top: 15px; border-color: rgba(255,255,255,0.1);" onclick="app.showScreen('screen-topic-detail')">Quit Exam</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <header>
            <h1>Exam Completed! üéâ</h1>
        </header>
        <div class="container">
            <div class="card" style="text-align: center;">
                <h2 style="margin-top:0; font-size: 2rem;">Your Performance</h2>
                
                <div id="result-circle" class="result-circle">
                    <span id="result-percentage" class="result-score-text">0%</span>
                </div>
                
                <h3 id="result-message" style="font-size: 1.8rem; margin-bottom: 10px;">Great Job!</h3>
                <p id="result-subtext" style="color: #cbd5e1; font-size: 1.2rem; margin-bottom: 35px;">You scored 0 out of 0 correctly.</p>

                <button class="btn btn-magic" onclick="app.showScreen('screen-dash')">Return to Dashboard ‚ûî</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4EBwp_tSyWgTnNsdBNnCNRa0Nzj1bAjjCuG2SaffMU1_wHuIFpieOouOb0Zl5KjpsrA/exec"; 
        const WHATSAPP_NUM = "https://wa.me/qr/O7FO3PRTOUFGO1"; 

        const allTopics = [
            { id: "1.1", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§≠‡•å‡§ó‡•ã‡§≤‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ, ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§∞ ‡§∏‡§æ‡§ß‡§®‡§π‡§∞‡•Ç" },
            { id: "1.2", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§ê‡§§‡§ø‡§π‡§æ‡§∏‡§ø‡§ï, ‡§∏‡§æ‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§ï ‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ" },
            { id: "1.3", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§∞ ‡§ö‡§æ‡§≤‡•Å ‡§Ü‡§µ‡§ß‡§ø‡§ï ‡§Ø‡•ã‡§ú‡§®‡§æ" },
            { id: "1.4", title: "‡§ú‡•à‡§µ‡§ø‡§ï ‡§µ‡§ø‡§µ‡§ø‡§ß‡§§‡§æ, ‡§¶‡§ø‡§ó‡•ã ‡§µ‡§ø‡§ï‡§æ‡§∏, ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£, ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®" },
            { id: "1.5", title: "‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§® ‡§∞ ‡§™‡•ç‡§∞‡§µ‡§ø‡§ß‡§ø‡§ï‡§æ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§ø‡§π‡§∞‡•Ç" },
            { id: "1.6", title: "‡§ú‡§®‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø, ‡§∞‡•ã‡§ó, ‡§ñ‡§æ‡§¶‡•ç‡§Ø ‡§∞ ‡§™‡•ã‡§∑‡§£" },
            { id: "1.7", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§∏‡§Ç‡§µ‡§ø‡§ß‡§æ‡§® (‡§≠‡§æ‡§ó ‡•ß ‡§¶‡•á‡§ñ‡§ø ‡•´ ‡§∞ ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä‡§π‡§∞‡•Ç)" },
            { id: "1.8", title: "‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§∏‡§Ç‡§ò ‡§∞ ‡§Ø‡§∏‡§ï‡§æ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ" },
            { id: "1.9", title: "‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•Ä‡§Ø ‡§∏‡§Ç‡§ó‡§†‡§® (‡§∏‡§æ‡§∞‡•ç‡§ï, ‡§¨‡§ø‡§Æ‡§∏‡•ç‡§ü‡•á‡§ï, ‡§Ü‡§∏‡§ø‡§Ø‡§æ‡§® ‡§∞ ‡§á‡§Ø‡•Å)" },
            { id: "1.10", title: "‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ø ‡§∞ ‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ø ‡§Æ‡§π‡§§‡•ç‡§µ‡§ï‡§æ ‡§∏‡§Æ‡§∏‡§æ‡§Æ‡§Ø‡§ø‡§ï ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§π‡§∞‡•Ç" },
            { id: "2.1", title: "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® (Office Management)" },
            { id: "2.2", title: "‡§®‡§ø‡§ú‡§æ‡§Æ‡§§‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ê‡§® ‡•®‡•¶‡•™‡•Ø" },
            { id: "2.3", title: "‡§®‡§ø‡§ú‡§æ‡§Æ‡§§‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä ‡•®‡•¶‡•´‡•¶" },
            { id: "2.4", title: "‡§∏‡§Ç‡§ò‡•Ä‡§Ø ‡§Æ‡§æ‡§Æ‡§ø‡§≤‡§æ ‡§§‡§•‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§® ‡§Æ‡§®‡•ç‡§§‡•ç‡§∞‡§æ‡§≤‡§Ø" },
            { id: "2.5", title: "‡§∏‡§Ç‡§µ‡•à‡§ß‡§æ‡§®‡§ø‡§ï ‡§®‡§ø‡§ï‡§æ‡§Ø ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä" },
            { id: "2.6", title: "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§¨‡§ú‡•á‡§ü, ‡§≤‡•á‡§ñ‡§æ ‡§∞ ‡§≤‡•á‡§ñ‡§æ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä" },
            { id: "2.7", title: "‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§π" },
            { id: "2.8", title: "‡§Æ‡§æ‡§®‡§µ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞, ‡§∏‡•Å‡§∂‡§æ‡§∏‡§® ‡§∞ ‡§∏‡•Ç‡§ö‡§®‡§æ‡§ï‡•ã ‡§π‡§ï" },
            { id: "2.9", title: "‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§¨‡§°‡§æ‡§™‡§§‡•ç‡§∞ (Public Charter)" },
            { id: "2.10", title: "‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§ï‡•ã ‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ (‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§®, ‡§®‡§ø‡§Ø‡§®‡•ç‡§§‡•ç‡§∞‡§£, ‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø)" },
            { id: "2.11", title: "‡§Æ‡§æ‡§®‡§µ‡•Ä‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§Æ‡§æ‡§®‡•ç‡§Ø‡§§‡§æ, ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø ‡§∞ ‡§Ö‡§®‡•Å‡§∂‡§æ‡§∏‡§®" }
        ];

        const app = {
            state: {
                user: null,
                isPremium: false,
                currentTopicId: null,
                quizSet: [], 
                currentIndex: 0,
                score: 0
            },

            init: function() {
                const savedUser = localStorage.getItem('loksewa_user');
                const savedPremium = localStorage.getItem('loksewa_premium');
                if (savedPremium === 'true') this.state.isPremium = true;
                if (savedUser) {
                    this.state.user = JSON.parse(savedUser);
                    this.buildDashboard();
                    this.showScreen('screen-dash');
                }
            },

            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            registerUser: function() {
                const name = document.getElementById('input-name').value.trim();
                const qual = document.getElementById('input-qual').value;
                if(!name || !qual) return alert("Please enter your Name and Qualification to continue.");
                this.state.user = { name, qual };
                localStorage.setItem('loksewa_user', JSON.stringify(this.state.user));
                this.buildDashboard();
                this.showScreen('screen-dash');
            },

            buildDashboard: function() {
                document.getElementById('dash-greeting').innerText = `Hello, ${this.state.user.name.split(" ")[0]}! üöÄ`;
                const container = document.getElementById('topics-container');
                container.innerHTML = "";

                allTopics.forEach((topic, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'topic-btn';
                    btn.style.animationDelay = `${index * 0.05}s`; 
                    btn.innerHTML = `<span class="topic-badge">${topic.id}</span> <span>${topic.title}</span>`;
                    btn.onclick = () => this.openTopic(topic);
                    container.appendChild(btn);
                });
            },

            openTopic: async function(topic) {
                this.state.currentTopicId = topic.id;
                document.getElementById('detail-topic-title').innerText = `${topic.id}: ${topic.title}`;
                const btnB = document.getElementById('btn-set-b');
                
                if (this.state.isPremium) {
                    btnB.innerText = "Set B - Unlocked ‚ú®";
                    btnB.className = "btn btn-magic";
                } else {
                    btnB.innerText = "Set B - Premium MCQs üîê";
                    btnB.className = "btn btn-premium";
                }
                this.showScreen('screen-topic-detail');
            },

            loadSet: async function(setType) {
                if (setType === 'B' && !this.state.isPremium) {
                    this.showScreen('screen-premium');
                    return;
                }
                try {
                    const response = await fetch(`data/${this.state.currentTopicId}.json`);
                    if (!response.ok) {
                        alert(`File not found: 'data/${this.state.currentTopicId}.json'. Please upload it to your GitHub.`);
                        return;
                    }
                    const data = await response.json();
                    
                    if (setType === 'A') {
                        this.state.quizSet = data.slice(0, 20);
                    } else {
                        this.state.quizSet = data.slice(20);
                        if(this.state.quizSet.length === 0) return alert("All questions completed for this topic!");
                    }
                    this.startQuiz();
                } catch (error) {
                    alert("JSON parsing error. Ensure your file is properly formatted.");
                    console.error(error);
                }
            },

            startQuiz: function() {
                this.state.currentIndex = 0;
                this.state.score = 0;
                this.showScreen('screen-quiz');
                this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.state.quizSet[this.state.currentIndex];
                const total = this.state.quizSet.length;
                const currentNum = this.state.currentIndex + 1;
                
                document.getElementById('quiz-progress-text').innerText = `Q: ${currentNum} / ${total}`;
                document.getElementById('quiz-score').innerText = `Score: ${this.state.score}`;
                document.getElementById('progress-fill').style.width = `${((currentNum - 1) / total) * 100}%`;
                
                document.getElementById('question-text').innerText = q.q;
                const optsDiv = document.getElementById('options-container');
                optsDiv.innerHTML = "";
                document.getElementById('explanation-box').style.display = 'none';
                document.getElementById('btn-next').classList.add('hidden');

                const labels = ['A', 'B', 'C', 'D'];
                q.o.forEach((opt, index) => {
                    const row = document.createElement('div');
                    row.className = 'option-row';
                    row.innerHTML = `<span class="opt-letter">${labels[index]}</span> <span>${opt}</span>`;
                    row.onclick = () => this.handleAnswer(index, row);
                    optsDiv.appendChild(row);
                });
            },

            handleAnswer: function(selectedIndex, rowElement) {
                const allRows = document.querySelectorAll('.option-row');
                allRows.forEach(r => r.style.pointerEvents = 'none');
                const q = this.state.quizSet[this.state.currentIndex];
                
                if (selectedIndex === q.a) {
                    rowElement.classList.add('correct');
                    this.state.score++;
                } else {
                    rowElement.classList.add('wrong');
                    allRows[q.a].classList.add('correct');
                }

                document.getElementById('quiz-score').innerText = `Score: ${this.state.score}`;
                const expBox = document.getElementById('explanation-box');
                if (q.e) {
                    expBox.innerText = `üí° Info: ${q.e}`;
                    expBox.style.display = 'block';
                }
                document.getElementById('btn-next').classList.remove('hidden');
                
                if (this.state.currentIndex === this.state.quizSet.length - 1) {
                    document.getElementById('progress-fill').style.width = `100%`;
                    document.getElementById('btn-next').innerText = "Finish Exam üéâ";
                } else {
                    document.getElementById('btn-next').innerText = "Next Question ‚ûî";
                }
            },

            nextQuestion: function() {
                this.state.currentIndex++;
                if (this.state.currentIndex < this.state.quizSet.length) {
                    this.renderQuestion();
                } else {
                    this.showResults();
                }
            },

            showResults: function() {
                this.showScreen('screen-result');
                const total = this.state.quizSet.length;
                const percentage = Math.round((this.state.score / total) * 100);
                
                document.getElementById('result-percentage').innerText = `${percentage}%`;
                document.getElementById('result-subtext').innerText = `You scored ${this.state.score} out of ${total} correctly.`;
                
                const circle = document.getElementById('result-circle');
                let color = percentage >= 80 ? '#00e676' : percentage >= 50 ? '#00d2ff' : '#ff1744';
                circle.style.background = `conic-gradient(${color} ${percentage}%, #333 0%)`;
                circle.style.boxShadow = `0 0 40px ${color}80`;

                const msgEl = document.getElementById('result-message');
                msgEl.style.color = color;
                if (percentage >= 80) msgEl.innerText = "Exceptional! üèÜ";
                else if (percentage >= 50) msgEl.innerText = "Solid Performance! üìà";
                else msgEl.innerText = "Keep Grinding! ‚öôÔ∏è";
            },

            requestWhatsAppCode: function() {
                const msg = `Hello! I am ${this.state.user.name} (${this.state.user.qual}). I want to unlock Set B Loksewa topics.`;
                window.open(`${WHATSAPP_NUM}?text=${encodeURIComponent(msg)}`, '_blank');
            },

            verifyCode: function() {
                const code = document.getElementById('input-code').value.trim();
                const passBox = document.getElementById('input-password');
                
                if (!code) return alert("Code cannot be empty.");

                const btn = document.getElementById('btn-verify');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Verifying <div class="loader"></div>';
                btn.style.pointerEvents = 'none';
                passBox.value = ''; 

                // FIX APPLIED HERE: Added &qual= to the fetch URL so the Google Sheet gets all required data!
                fetch(`${WEB_APP_URL}?code=${code}&name=${this.state.user.name}&qual=${this.state.user.qual}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            
                            passBox.value = data.password || Math.floor(100000 + Math.random() * 900000); 
                            
                            btn.innerHTML = 'Access Granted ‚ú®';
                            btn.classList.add('btn-magic');

                            setTimeout(() => {
                                alert("Password Auto-Filled! Premium Access Granted. üöÄ");
                                this.state.isPremium = true;
                                localStorage.setItem('loksewa_premium', 'true');
                                this.showScreen('screen-topic-detail');
                                this.openTopic({ id: this.state.currentTopicId, title: document.getElementById('detail-topic-title').innerText.split(': ')[1] }); 
                            }, 1200);

                        } else {
                            alert(data.message || "Invalid Code");
                            btn.innerHTML = originalText;
                            btn.style.pointerEvents = 'auto';
                        }
                    })
                    .catch(() => {
                        alert("Network Error. Please try again.");
                        btn.innerHTML = originalText;
                        btn.style.pointerEvents = 'auto';
                    });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
