<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Loksewa Exam Master Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Serif+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --success: #00e676; --danger: #ff1744;
            --text-main: #ffffff; --ui-font: 'Poppins', sans-serif; --exam-font: 'Noto Serif Devanagari', serif;
        }

        /* --- VIBRANT BG --- */
        body {
            font-family: var(--ui-font); margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(-45deg, #ff00cc, #333399, #00d2ff, #3a7bd5);
            background-size: 400% 400%; animation: vibrantBG 12s ease infinite;
            min-height: 100vh; overflow-x: hidden;
        }
        @keyframes vibrantBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- SCREENS --- */
        .screen { display: none; min-height: 100vh; padding-bottom: 50px; }
        .screen.active { display: block; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        /* --- HEADER & CARDS --- */
        header { padding: 30px 20px 10px; text-align: center; }
        header h1 { margin: 0; font-size: 2.8rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 20px rgba(255,255,255,0.4); }
        header p { margin: 5px 0 20px; font-weight: 600; color: #e0e7ff; }

        .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .card {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; padding: 35px 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.05); margin-bottom: 20px;
        }

        /* --- DASHBOARD PROFILE BANNER --- */
        .profile-banner {
            background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 210, 255, 0.3);
            border-radius: 20px; padding: 15px 20px; display: flex; align-items: center;
            margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .pb-avatar-wrap {
            position: relative; width: 65px; height: 65px; flex-shrink: 0;
            border-radius: 50%; border: 2px solid #00d2ff; background: #1e293b;
            display: flex; align-items: center; justify-content: center;
        }
        .pb-avatar-wrap img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .pb-upload-badge {
            position: absolute; bottom: -4px; right: -4px; background: #ff00cc;
            width: 26px; height: 26px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            font-size: 0.8rem; box-shadow: 0 0 10px rgba(255,0,204,0.6);
            border: 2px solid #0f172a; transition: 0.2s;
        }
        .pb-upload-badge:active { transform: scale(0.9); }
        .pb-info { margin-left: 15px; flex-grow: 1; }
        .pb-name { font-size: 1.3rem; font-weight: 800; margin: 0; color: #fff; line-height: 1.2; }
        .pb-qual { font-size: 0.9rem; color: #00d2ff; margin: 3px 0 0 0; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* --- HOME PROFILE UPLOAD UI --- */
        .profile-upload-wrapper {
            width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px auto;
            border: 3px dashed #00d2ff; display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden; background: rgba(0,0,0,0.3); transition: 0.3s;
        }
        .profile-upload-wrapper:hover { border-style: solid; box-shadow: 0 0 20px rgba(0,210,255,0.5); }
        .profile-upload-wrapper img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-text { font-size: 0.9rem; font-weight: 600; color: #00d2ff; text-align: center; position: absolute; }
        .hidden-file { display: none; }

        /* --- INPUTS --- */
        input, select {
            width: 100%; padding: 18px; margin: 10px 0 20px 0; border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.5); color: #fff; border-radius: 16px; font-size: 1.1rem;
            font-family: var(--ui-font); box-sizing: border-box; transition: 0.3s ease;
        }
        input:focus, select:focus { border-color: #00d2ff; outline: none; box-shadow: 0 0 20px rgba(0, 210, 255, 0.4); }
        select option { background: #0f172a; color: #fff; }
        .input-secure { text-align: center; font-weight: 900; font-size: 1.2rem; letter-spacing: 8px; color: var(--success); cursor: not-allowed; }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 16px; font-size: 1.2rem; font-weight: 800;
            cursor: pointer; transition: 0.2s; display: block; box-sizing: border-box; color: white;
            text-transform: uppercase; letter-spacing: 1px; z-index: 1; position: relative;
        }
        .btn:active { transform: scale(0.95); }
        .btn-magic { background: #0f172a; overflow: visible; }
        .btn-magic::before { content: ''; position: absolute; inset: -3px; background: linear-gradient(90deg, #ff00cc, #333399, #00d2ff, #ff00cc); background-size: 300%; z-index: -1; border-radius: 19px; animation: gradientBorder 3s linear infinite; }
        .btn-magic::after { content: ''; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.9); border-radius: 16px; z-index: -1; }
        .btn-success { background: linear-gradient(135deg, #00b09b, #96c93d); box-shadow: 0 0 20px rgba(150, 201, 61, 0.5); }
        .btn-premium { background: linear-gradient(135deg, #f12711, #f5af19); box-shadow: 0 0 20px rgba(245, 175, 25, 0.4); }
        .btn-mistake { background: linear-gradient(135deg, #8b5cf6, #ec4899); box-shadow: 0 0 20px rgba(236, 72, 153, 0.4); margin-bottom: 20px; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); margin-top: 15px; }
        @keyframes gradientBorder { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
     
   /* --- HORIZONTAL NAV BUTTONS (APP HUB) --- */
        .app-nav-row { display: flex; gap: 8px; width: 100%; margin-bottom: 25px; }
        .nav-magic-btn {
            flex: 1; background: #0f172a; position: relative; padding: 12px 2px;
            font-size: 0.8rem; font-weight: 800; color: #fff; text-align: center;
            text-transform: uppercase; border: none; border-radius: 12px; cursor: pointer;
            z-index: 1; transition: 0.2s; letter-spacing: 0.5px;
        }
        .nav-magic-btn:active { transform: scale(0.95); }
        .nav-magic-btn::before {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(90deg, #ff00cc, #333399, #00d2ff, #ff00cc);
            background-size: 300%; z-index: -1; border-radius: 14px;
            animation: gradientBorder 3s linear infinite;
        }
        .nav-magic-btn::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.95); border-radius: 12px; z-index: -1;
        }
        .nav-magic-btn:hover::before { filter: blur(6px); }

   /* --- GRID --- */
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .topic-btn {
            background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 16px; 
            font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; cursor: pointer;
            transition: 0.3s; position: relative; overflow: hidden; opacity: 0; animation: slideIn 0.5s forwards;
        }
        .topic-btn:hover { transform: translateY(-3px) scale(1.02); border-color: #00d2ff; background: rgba(0, 0, 0, 0.6); box-shadow: 0 10px 30px rgba(0, 210, 255, 0.3); }
        .topic-badge { background: linear-gradient(135deg, #ff00cc, #333399); color: white; padding: 8px 14px; border-radius: 12px; margin-right: 15px; flex-shrink: 0; box-shadow: 0 0 15px rgba(255,0,204,0.5); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

        /* --- EXAM PAPER --- */
        .exam-paper { background: #ffffff; color: #111; padding: 35px 25px; border-radius: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.3); font-family: var(--exam-font); }
        .question-text { font-size: 1.5rem; font-weight: 700; margin-bottom: 30px; line-height: 1.6; }
        .option-row { padding: 16px; border: 2px solid #e2e8f0; margin-bottom: 12px; border-radius: 14px; cursor: pointer; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; transition: 0.2s; background: #f8fafc; }
        .option-row:hover { border-color: #6366f1; transform: scale(1.02); }
        .opt-letter { font-weight: 900; margin-right: 15px; color: #fff; background: #6366f1; padding: 6px 14px; border-radius: 8px; font-family: var(--ui-font); }
        .option-row.correct { background: #00e676; border-color: #00c853; color: #000; box-shadow: 0 0 20px rgba(0, 230, 118, 0.4); }
        .option-row.correct .opt-letter { background: #000; color: #00e676; }
        .option-row.wrong { background: #ff1744; border-color: #d50000; color: #fff; box-shadow: 0 0 20px rgba(255, 23, 68, 0.4); }
        .option-row.wrong .opt-letter { background: #000; color: #ff1744; }
        .explanation { margin-top: 25px; padding: 20px; background: #e0e7ff; border-left: 6px solid #6366f1; font-size: 1.2rem; display: none; border-radius: 0 12px 12px 0; }
        
        /* --- PROGRESS & AUDIO BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mute-btn { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;}
        .progress-container { width: 100%; background: rgba(0,0,0,0.5); border-radius: 20px; height: 14px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00d2ff, #3a7bd5); width: 0%; transition: 0.4s; border-radius: 20px; box-shadow: 0 0 15px #00d2ff;}
        .score-badge { background: rgba(0,0,0,0.6); border: 1px solid #00d2ff; padding: 8px 20px; border-radius: 20px; font-weight: 800; color: #00d2ff; }

        /* --- RESULT SCREEN --- */
        .result-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #00d2ff; object-fit: cover; margin: -60px auto 15px auto; display: block; background: #1e293b; box-shadow: 0 0 20px rgba(0,210,255,0.5);}
        .result-score-text { font-size: 4rem; font-weight: 900; color: #00e676; text-shadow: 0 0 20px rgba(0,230,118,0.5); margin: 10px 0; line-height: 1;}
        .advice-box { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <header>
            <h1>Loksewa Pro</h1>
            <p>Adaptive Exam Preparation</p>
        </header>
        <div class="container">
            <div class="card">
                <label class="profile-upload-wrapper" for="file-upload-home" id="profile-preview-box">
                    <span class="upload-text" id="home-upload-text">Upload<br>Photo</span>
                    <img id="profile-img-preview" src="">
                </label>
                <input type="file" id="file-upload-home" class="hidden-file" accept="image/*" onchange="app.handleImageUpload(event)">

                <input type="text" id="input-name" placeholder="Enter Full Name">
                <select id="input-qual">
                    <option value="" disabled selected>Select Qualification</option>
                    <option value="Sub Engineer">Sub Engineer</option>
                    <option value="Engineer">Engineer</option>
                    <option value="Asst Sub Engineer">Asst. Sub Engineer</option>
                </select>
                <button class="btn btn-magic" onclick="app.registerUser()">Enter Portal ‚ûî</button>
            </div>
        </div>
    </div>

    <div id="screen-dash" class="screen">
        <div class="container" style="padding-top: 35px;">
            
            <div class="app-nav-row">
                <button class="nav-magic-btn" onclick="window.location.href='https://9865637898.github.io/MadheshQuiz/'">Madhesh</button>
                <button class="nav-magic-btn" onclick="window.location.href='https://9865637898.github.io/Numericallink/'">Numericals</button>
                <button class="nav-magic-btn" onclick="window.location.href='https://antinogutress-maker.github.io/SMARTMOCK/'">Random</button>
            </div>
            
            <div class="profile-banner">
                <div class="pb-avatar-wrap">
                    <img id="dash-profile-img" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2364748b'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>">
                    
                    <label for="file-upload-dash" id="dash-upload-btn" class="pb-upload-badge">üì∑</label>
                    <input type="file" id="file-upload-dash" class="hidden-file" accept="image/*" onchange="app.handleImageUpload(event)">
                </div>
                <div class="pb-info">
                    <h2 class="pb-name" id="dash-name">Name</h2>
                    <p class="pb-qual" id="dash-qual">Qualification</p>
                </div>
            </div>

            <div id="topics-container" class="topic-grid"></div>
        </div>
    </div>

    <div id="screen-topic-detail" class="screen">
        <header>
            <h1 id="detail-topic-title" style="font-size: 1.8rem;">Topic Title</h1>
        </header>
        <div class="container">
            <div class="card" style="text-align: center;">
                <h3 style="margin-top:0; font-size: 1.6rem;">Select Practice Set</h3>
                <p style="color:#cbd5e1; margin-bottom: 30px;">Engage in a realistic, time-efficient mock exam.</p>

                <button class="btn btn-magic" style="margin-bottom: 20px;" onclick="app.loadSet('A')">
                    Set A - Free Preview (First 20)
                </button>
                
                <button id="btn-set-b" class="btn btn-premium" style="margin-bottom: 20px;" onclick="app.loadSet('B')">
                    Set B - Premium MCQs üîê
                </button>

                <button id="btn-mistake-bank" class="btn btn-mistake hidden" onclick="app.loadMistakeBank()">
                    üìÇ Review Mistakes (<span id="mistake-count">0</span>)
                </button>

                <button class="btn btn-outline" onclick="app.showScreen('screen-dash')">‚Üê Back to Topics</button>
            </div>
        </div>
    </div>

    <div id="screen-premium" class="screen">
        <header>
            <h1>Unlock Premium üîê</h1>
        </header>
        <div class="container">
            <div class="card" style="text-align: center;">
                <h2 style="font-weight: 900; font-size: 2rem;">Full Access</h2>
                <p style="color:#cbd5e1; margin-bottom: 20px;">Unlock Set B across the entire syllabus permanently.</p>
                <input type="text" id="input-code" placeholder="ENTER SECRET CODE" style="text-align:center; font-weight:900; font-size: 1.4rem; letter-spacing: 4px; text-transform: uppercase;">
                <input type="text" id="input-password" class="input-secure" placeholder="PASSWORD AUTO-FILL" readonly>
                <button id="btn-verify" class="btn btn-success" style="margin-bottom: 25px;" onclick="app.verifyCode()">Verify & Unlock</button>
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 30px 0;">
                <button class="btn btn-premium" style="margin-bottom: 15px;" onclick="app.requestWhatsAppCode()">Get Code via WhatsApp üí¨</button>
                <button class="btn btn-outline" onclick="app.showScreen('screen-topic-detail')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="container" style="padding-top: 20px;">
            <div class="top-bar">
                <span id="quiz-progress-text" style="font-weight: 900; font-size: 1.2rem;">Q: 1/20</span>
                <button class="mute-btn" id="btn-mute" onclick="app.toggleMute()">üîä</button>
                <span id="quiz-score" class="score-badge">Score: 0</span>
            </div>
            <div class="progress-container"><div id="progress-fill" class="progress-fill"></div></div>
            <div class="exam-paper">
                <div id="question-text" class="question-text">Loading question...</div>
                <div id="options-container"></div>
                <div id="explanation-box" class="explanation"></div>
            </div>
            <button id="btn-next" class="btn btn-magic hidden" style="margin-top: 30px;" onclick="app.nextQuestion()">Next Question ‚ûî</button>
            <button class="btn btn-outline" style="margin-top: 15px; border-color: rgba(255,255,255,0.1);" onclick="app.showScreen('screen-topic-detail')">Quit Exam</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <header>
            <h1 id="result-title">Exam Completed! üéâ</h1>
        </header>
        <div class="container">
            <div class="card" style="text-align: center; margin-top: 40px;">
                <img id="result-profile-img" class="result-avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2364748b'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>">
                <h2 id="result-name" style="margin-top: 0; font-size: 1.8rem;">Outstanding work!</h2>
                
                <div id="result-percentage" class="result-score-text">0%</div>
                
                <p id="result-accuracy" style="color: #cbd5e1; font-size: 1.1rem; margin-bottom: 20px; font-weight: 600;">
                    You attempted 20 questions, got 15 correct, and made 5 mistakes.
                </p>

                <div class="advice-box">
                    <p id="result-advice" style="margin:0; font-size: 1.1rem; color: #00d2ff; font-weight: 600;">Advice loading...</p>
                </div>

                <button class="btn btn-magic" onclick="app.showScreen('screen-dash')">Return to Dashboard ‚ûî</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4EBwp_tSyWgTnNsdBNnCNRa0Nzj1bAjjCuG2SaffMU1_wHuIFpieOouOb0Zl5KjpsrA/exec"; 
        const WHATSAPP_NUM = "https://wa.me/qr/O7FO3PRTOUFGO1"; 

        const allTopics = [
            { id: "1.1", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§≠‡•å‡§ó‡•ã‡§≤‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ, ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§∞ ‡§∏‡§æ‡§ß‡§®‡§π‡§∞‡•Ç" },
            { id: "1.2", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§ê‡§§‡§ø‡§π‡§æ‡§∏‡§ø‡§ï, ‡§∏‡§æ‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§ï ‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ" },
            { id: "1.3", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§∞ ‡§ö‡§æ‡§≤‡•Å ‡§Ü‡§µ‡§ß‡§ø‡§ï ‡§Ø‡•ã‡§ú‡§®‡§æ" },
            { id: "1.4", title: "‡§ú‡•à‡§µ‡§ø‡§ï ‡§µ‡§ø‡§µ‡§ø‡§ß‡§§‡§æ, ‡§¶‡§ø‡§ó‡•ã ‡§µ‡§ø‡§ï‡§æ‡§∏, ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£, ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®" },
            { id: "1.5", title: "‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§® ‡§∞ ‡§™‡•ç‡§∞‡§µ‡§ø‡§ß‡§ø‡§ï‡§æ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§ø‡§π‡§∞‡•Ç" },
            { id: "1.6", title: "‡§ú‡§®‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø, ‡§∞‡•ã‡§ó, ‡§ñ‡§æ‡§¶‡•ç‡§Ø ‡§∞ ‡§™‡•ã‡§∑‡§£" },
            { id: "1.7", title: "‡§®‡•á‡§™‡§æ‡§≤‡§ï‡•ã ‡§∏‡§Ç‡§µ‡§ø‡§ß‡§æ‡§® (‡§≠‡§æ‡§ó ‡•ß ‡§¶‡•á‡§ñ‡§ø ‡•´ ‡§∞ ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä‡§π‡§∞‡•Ç)" },
            { id: "1.8", title: "‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§∏‡§Ç‡§ò ‡§∞ ‡§Ø‡§∏‡§ï‡§æ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ" },
            { id: "1.9", title: "‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•Ä‡§Ø ‡§∏‡§Ç‡§ó‡§†‡§® (‡§∏‡§æ‡§∞‡•ç‡§ï, ‡§¨‡§ø‡§Æ‡§∏‡•ç‡§ü‡•á‡§ï, ‡§Ü‡§∏‡§ø‡§Ø‡§æ‡§® ‡§∞ ‡§á‡§Ø‡•Å)" },
            { id: "1.10", title: "‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ø ‡§∞ ‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ø ‡§Æ‡§π‡§§‡•ç‡§µ‡§ï‡§æ ‡§∏‡§Æ‡§∏‡§æ‡§Æ‡§Ø‡§ø‡§ï ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§π‡§∞‡•Ç" },
            { id: "2.1", title: "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® (Office Management)" },
            { id: "2.2", title: "‡§®‡§ø‡§ú‡§æ‡§Æ‡§§‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ê‡§® ‡•®‡•¶‡•™‡•Ø" },
            { id: "2.3", title: "‡§®‡§ø‡§ú‡§æ‡§Æ‡§§‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä ‡•®‡•¶‡•´‡•¶" },
            { id: "2.4", title: "‡§∏‡§Ç‡§ò‡•Ä‡§Ø ‡§Æ‡§æ‡§Æ‡§ø‡§≤‡§æ ‡§§‡§•‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§® ‡§Æ‡§®‡•ç‡§§‡•ç‡§∞‡§æ‡§≤‡§Ø" },
            { id: "2.5", title: "‡§∏‡§Ç‡§µ‡•à‡§ß‡§æ‡§®‡§ø‡§ï ‡§®‡§ø‡§ï‡§æ‡§Ø ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä" },
            { id: "2.6", title: "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§¨‡§ú‡•á‡§ü, ‡§≤‡•á‡§ñ‡§æ ‡§∞ ‡§≤‡•á‡§ñ‡§æ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä" },
            { id: "2.7", title: "‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§π" },
            { id: "2.8", title: "‡§Æ‡§æ‡§®‡§µ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞, ‡§∏‡•Å‡§∂‡§æ‡§∏‡§® ‡§∞ ‡§∏‡•Ç‡§ö‡§®‡§æ‡§ï‡•ã ‡§π‡§ï" },
            { id: "2.9", title: "‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§¨‡§°‡§æ‡§™‡§§‡•ç‡§∞ (Public Charter)" },
            { id: "2.10", title: "‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§ï‡•ã ‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ (‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§®, ‡§®‡§ø‡§Ø‡§®‡•ç‡§§‡•ç‡§∞‡§£, ‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø)" },
            { id: "2.11", title: "‡§Æ‡§æ‡§®‡§µ‡•Ä‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§Æ‡§æ‡§®‡•ç‡§Ø‡§§‡§æ, ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø ‡§∞ ‡§Ö‡§®‡•Å‡§∂‡§æ‡§∏‡§®" }
        ];

        // --- ADVANCED AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const AudioEngine = {
            playCustomTone: function(freq, type, duration, vol, isGlide = false, endFreq = null, isMuffled = false) {
                if (app.state.isMuted) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                
                // Frequency Envelope (Glide or Steady)
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                if (isGlide && endFreq) {
                    osc.frequency.exponentialRampToValueAtTime(endFreq, audioCtx.currentTime + duration);
                }

                // Volume Envelope (Punchy attack, quick decay)
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

                // Optional Filter for "Wrong" sounds to make it a soft thud
                if (isMuffled) {
                    const filter = audioCtx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(800, audioCtx.currentTime);
                    filter.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + duration);
                    osc.connect(filter);
                    filter.connect(gain);
                } else {
                    osc.connect(gain);
                }

                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            
            // Bright, premium UI pop (Two rapid ascending notes)
            correct: () => {
                AudioEngine.playCustomTone(880, 'sine', 0.1, 0.4); // A5
                setTimeout(() => AudioEngine.playCustomTone(1318.51, 'sine', 0.3, 0.3), 80); // E6
            },
            
            // Soft, descending muffled thud
            wrong: () => {
                AudioEngine.playCustomTone(200, 'sawtooth', 0.3, 0.5, true, 50, true);
            },
            
            // Grand major chord arpeggio
            tada: () => {
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                notes.forEach((freq, i) => {
                    setTimeout(() => AudioEngine.playCustomTone(freq, 'triangle', 0.4, 0.2), i * 100);
                });
                // Final sustained chord
                setTimeout(() => {
                    notes.forEach(freq => AudioEngine.playCustomTone(freq, 'sine', 1.2, 0.15));
                }, notes.length * 100);
            }
        };

        const app = {
            state: {
                user: { name: "", qual: "", pic: "" },
                isPremium: false, currentTopicId: null, quizSet: [], 
                currentIndex: 0, score: 0, isMuted: false, mistakes: {}, isMistakeMode: false
            },

            init: function() {
                const savedUser = localStorage.getItem('loksewa_user');
                const savedPremium = localStorage.getItem('loksewa_premium');
                const savedMistakes = localStorage.getItem('loksewa_mistakes');
                
                if (savedPremium === 'true') this.state.isPremium = true;
                if (savedMistakes) this.state.mistakes = JSON.parse(savedMistakes);

                if (savedUser) {
                    this.state.user = JSON.parse(savedUser);
                    this.buildDashboard();
                    this.showScreen('screen-dash');
                }
            },

            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            // UNIVERSAL COMPRESSION LOGIC (Used for both Home and Dashboard)
            handleImageUpload: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        canvas.width = 200; canvas.height = 200;
                        const size = Math.min(img.width, img.height);
                        const sx = (img.width - size) / 2, sy = (img.height - size) / 2;
                        ctx.drawImage(img, sx, sy, size, size, 0, 0, 200, 200);
                        const base64Pic = canvas.toDataURL('image/jpeg', 0.7); 
                        
                        this.state.user.pic = base64Pic;
                        
                        // If they are doing this from Dashboard, save immediately
                        if(this.state.user.name) {
                            localStorage.setItem('loksewa_user', JSON.stringify(this.state.user));
                            this.updateProfileUIs();
                        } else {
                            // If they are doing this from Home before registering
                            document.getElementById('home-upload-text').style.display = 'none';
                            const preview = document.getElementById('profile-img-preview');
                            preview.src = base64Pic; preview.style.display = 'block';
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            updateProfileUIs: function() {
                if(this.state.user.pic) {
                    // Update Dashboard
                    document.getElementById('dash-profile-img').src = this.state.user.pic;
                    document.getElementById('dash-upload-btn').style.display = 'none'; // Erase Camera
                    // Update Result Screen
                    document.getElementById('result-profile-img').src = this.state.user.pic;
                }
            },

            registerUser: function() {
                const name = document.getElementById('input-name').value.trim();
                const qual = document.getElementById('input-qual').value;
                if(!name || !qual) return alert("Please enter your Name and Qualification to continue.");
                this.state.user.name = name; this.state.user.qual = qual;
                localStorage.setItem('loksewa_user', JSON.stringify(this.state.user));
                this.buildDashboard();
                this.showScreen('screen-dash');
            },

            buildDashboard: function() {
                // Populate Profile Banner
                document.getElementById('dash-name').innerText = this.state.user.name;
                document.getElementById('dash-qual').innerText = this.state.user.qual;
                this.updateProfileUIs(); // Triggers pic logic and hides camera if image exists

                const container = document.getElementById('topics-container');
                container.innerHTML = "";
                allTopics.forEach((topic, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'topic-btn'; btn.style.animationDelay = `${index * 0.05}s`; 
                    btn.innerHTML = `<span class="topic-badge">${topic.id}</span> <span>${topic.title}</span>`;
                    btn.onclick = () => this.openTopic(topic);
                    container.appendChild(btn);
                });
            },

            openTopic: async function(topic) {
                this.state.currentTopicId = topic.id;
                document.getElementById('detail-topic-title').innerText = `${topic.id}: ${topic.title}`;
                
                const btnB = document.getElementById('btn-set-b');
                if (this.state.isPremium) { btnB.innerText = "Set B - Unlocked ‚ú®"; btnB.className = "btn btn-magic"; } 
                else { btnB.innerText = "Set B - Premium MCQs üîê"; btnB.className = "btn btn-premium"; }

                const topicMistakes = this.state.mistakes[this.state.currentTopicId] || [];
                const mBankBtn = document.getElementById('btn-mistake-bank');
                if (topicMistakes.length > 0) {
                    document.getElementById('mistake-count').innerText = topicMistakes.length;
                    mBankBtn.classList.remove('hidden');
                } else { mBankBtn.classList.add('hidden'); }

                this.showScreen('screen-topic-detail');
            },

            loadSet: async function(setType) {
                this.state.isMistakeMode = false;
                if (setType === 'B' && !this.state.isPremium) { this.showScreen('screen-premium'); return; }
                try {
                    const response = await fetch(`data/${this.state.currentTopicId}.json`);
                    if (!response.ok) return alert(`File not found: 'data/${this.state.currentTopicId}.json'. Please upload it.`);
                    const data = await response.json();
                    if (setType === 'A') this.state.quizSet = data.slice(0, 20);
                    else this.state.quizSet = data.slice(20);
                    if(this.state.quizSet.length === 0) return alert("No questions available in this set!");
                    this.startQuiz();
                } catch (e) { alert("JSON error. Check format."); console.error(e); }
            },

            loadMistakeBank: function() {
                this.state.isMistakeMode = true;
                this.state.quizSet = [...this.state.mistakes[this.state.currentTopicId]];
                this.startQuiz();
            },

            toggleMute: function() {
                this.state.isMuted = !this.state.isMuted;
                document.getElementById('btn-mute').innerText = this.state.isMuted ? 'üîá' : 'üîä';
            },

            startQuiz: function() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                this.state.currentIndex = 0; this.state.score = 0;
                this.showScreen('screen-quiz'); this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.state.quizSet[this.state.currentIndex];
                const total = this.state.quizSet.length; const currentNum = this.state.currentIndex + 1;
                document.getElementById('quiz-progress-text').innerText = this.state.isMistakeMode ? `Mistakes: ${currentNum}/${total}` : `Q: ${currentNum}/${total}`;
                document.getElementById('quiz-score').innerText = `Score: ${this.state.score}`;
                document.getElementById('progress-fill').style.width = `${((currentNum - 1) / total) * 100}%`;
                document.getElementById('question-text').innerText = q.q;
                
                const optsDiv = document.getElementById('options-container'); optsDiv.innerHTML = "";
                document.getElementById('explanation-box').style.display = 'none';
                document.getElementById('btn-next').classList.add('hidden');

                const labels = ['A', 'B', 'C', 'D'];
                q.o.forEach((opt, index) => {
                    const row = document.createElement('div'); row.className = 'option-row';
                    row.innerHTML = `<span class="opt-letter">${labels[index]}</span> <span>${opt}</span>`;
                    row.onclick = () => this.handleAnswer(index, row); optsDiv.appendChild(row);
                });
            },

            handleAnswer: function(selectedIndex, rowElement) {
                const allRows = document.querySelectorAll('.option-row');
                allRows.forEach(r => r.style.pointerEvents = 'none');
                const topicId = this.state.currentTopicId; const q = this.state.quizSet[this.state.currentIndex];
                const isCorrect = selectedIndex === q.a;

                if (!this.state.mistakes[topicId]) this.state.mistakes[topicId] = [];

                if (isCorrect) {
                    rowElement.classList.add('correct'); this.state.score++; AudioEngine.correct();
                    if (this.state.isMistakeMode) {
                        this.state.mistakes[topicId] = this.state.mistakes[topicId].filter(item => item.q !== q.q);
                        localStorage.setItem('loksewa_mistakes', JSON.stringify(this.state.mistakes));
                    }
                } else {
                    rowElement.classList.add('wrong'); allRows[q.a].classList.add('correct'); AudioEngine.wrong();
                    if (!this.state.mistakes[topicId].find(item => item.q === q.q)) {
                        this.state.mistakes[topicId].push(q);
                        localStorage.setItem('loksewa_mistakes', JSON.stringify(this.state.mistakes));
                    }
                }

                document.getElementById('quiz-score').innerText = `Score: ${this.state.score}`;
                const expBox = document.getElementById('explanation-box');
                if (q.e) { expBox.innerText = `üí° Info: ${q.e}`; expBox.style.display = 'block'; }
                document.getElementById('btn-next').classList.remove('hidden');
                
                if (this.state.currentIndex === this.state.quizSet.length - 1) {
                    document.getElementById('progress-fill').style.width = `100%`;
                    document.getElementById('btn-next').innerText = "Finish Exam üéâ";
                } else { document.getElementById('btn-next').innerText = "Next Question ‚ûî"; }
            },

            nextQuestion: function() {
                this.state.currentIndex++;
                if (this.state.currentIndex < this.state.quizSet.length) this.renderQuestion();
                else this.showResults();
            },

            showResults: function() {
                this.showScreen('screen-result'); AudioEngine.tada();
                const total = this.state.quizSet.length; const mistakesMade = total - this.state.score;
                const percentage = Math.round((this.state.score / total) * 100);
                
                document.getElementById('result-name').innerText = `Exam Completed, ${this.state.user.name.split(" ")[0]}!`;
                document.getElementById('result-percentage').innerText = `${percentage}%`;
                document.getElementById('result-accuracy').innerText = `You attempted ${total} questions, got ${this.state.score} correct, and made ${mistakesMade} mistake${mistakesMade===1?'':'s'}.`;

                const percentEl = document.getElementById('result-percentage');
                let color = percentage >= 80 ? '#00e676' : percentage >= 60 ? '#00d2ff' : percentage >= 40 ? '#f59e0b' : '#ff1744';
                percentEl.style.color = color; percentEl.style.textShadow = `0 0 20px ${color}80`;

                let adviceStr = "";
                if (percentage >= 80) adviceStr = "Outstanding! üèÜ Your preparation is excellent. Keep reviewing to maintain this mastery for the final exam.";
                else if (percentage >= 60) adviceStr = "Good Job! üìà You are very close to your goal. Focus on your Mistake Bank to push this score over 80%.";
                else if (percentage >= 40) adviceStr = "Fair Effort. ‚öôÔ∏è You have a foundation, but you need to increase your study hours. Consistency is key for Loksewa.";
                else adviceStr = "Needs Work. ‚ö†Ô∏è Don't lose hope, but you must work much harder to make your Loksewa journey successful. Practice daily!";
                
                const advEl = document.getElementById('result-advice');
                advEl.innerText = adviceStr; advEl.style.color = color;
            },

            requestWhatsAppCode: function() { window.open(`${WHATSAPP_NUM}?text=${encodeURIComponent(`Hello! I am ${this.state.user.name} (${this.state.user.qual}). I want to unlock Set B Loksewa topics.`)}`, '_blank'); },

            verifyCode: function() {
                const code = document.getElementById('input-code').value.trim(); const passBox = document.getElementById('input-password');
                if (!code) return alert("Code cannot be empty.");
                const btn = document.getElementById('btn-verify'); const originalText = btn.innerHTML;
                btn.innerHTML = 'Verifying <div class="loader"></div>'; btn.style.pointerEvents = 'none'; passBox.value = ''; 

                fetch(`${WEB_APP_URL}?code=${code}&name=${this.state.user.name}&qual=${this.state.user.qual}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            passBox.value = data.password || Math.floor(100000 + Math.random() * 900000); 
                            btn.innerHTML = 'Access Granted ‚ú®'; btn.classList.add('btn-magic');
                            setTimeout(() => {
                                alert("Premium Access Granted. üöÄ");
                                this.state.isPremium = true; localStorage.setItem('loksewa_premium', 'true');
                                this.showScreen('screen-topic-detail');
                                this.openTopic({ id: this.state.currentTopicId, title: document.getElementById('detail-topic-title').innerText.split(': ')[1] }); 
                            }, 1200);
                        } else { alert(data.message || "Invalid Code"); btn.innerHTML = originalText; btn.style.pointerEvents = 'auto'; }
                    }).catch(() => { alert("Network Error."); btn.innerHTML = originalText; btn.style.pointerEvents = 'auto'; });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>


